# PaySystem

## 🚀프로젝트 소개

이 프로젝트는 스트리밍 플랫폼이 판매자를 위한 **통계 및 정산 관리 시스템**을 개발하기 위해 설계된 개인 프로젝트 입니다. 
판매자들이 콘텐츠 성과와 수익을 효율적으로 관리하고 분석할 수 있는 기능을 제공합니다.

초기에는 모놀리식(레이어드 아키텍처) 구조로 설계되었으나, **마이크로서비스 아키텍처(MSA)로 전환**하여 회원 관리, 스트리밍 관리, 정산 관리 서비스를 독립적으로 운영할 수 있도록 설계되었습니다.
이를 통해 각 서비스의 유연성과 확장성을 강화하고, 대규모 데이터를 안정적으로 처리할 수 있는 구조로 구현했습니다.

**개발 기간**

2024.10.16 ~ 2024.11.12 (4주)

## 🛠기술스택
- Spring Boot, Spring Batch, Spring Security, Java, Gradle
- MySQL, JPA
- Redis
- Spring Cloud Gateway, Eureka, Resilience4J
- Docker-Compose, Github

## 💻 Docker-Compose 실행 명령어

```
docker-compose up -d
```

## 🏗 아키텍쳐

![ex_screenshot](./image/paySystem_architecture.png)

## 🗂 ERD

![ex_screenshot](./image/ERD.png)

## 🔨 API 명세서

**API 명세서 한눈에 보기**

|       회원 관리        |   스트리밍 관리    | 정산 관리 | 
|:------------------:|:------------:|:-----:|
| 카카오 로그인<br> 및 회원가입 |    동영상 조회    | 통계 조회 |
|        로그아웃        | 동영상 재생 또는 정지 | 정산 조회 | 
|                    |    광고 삽입     |       |


[API 명세서 자세히 보기](https://documenter.getpostman.com/view/19722199/2sAY55ad9r)


## 🌟주요 기능

### 회원 관리 (User Service)

- 소셜 및 JWT를 활용한 회원가입/로그인/로그아웃

### 스트리밍 관리 (Streaming Service)

- 등록된 동영상을 조회
- 동영상 재생 및 정지
- 광고 삽입

### 정산 괸리 (Revenue Service)

- 일간, 주간, 월간 조회수 및 재생 시간의 Top5 조회
- 일간, 주간, 월간 정산 내역 조회

배치 작업
- 일일 콘텐츠 조회 수 및 재생 시간을 기반으로 한 통계 생성
- 일간, 주간, 월간 정산 데이터 집계


## 🔥성능 최적화

1. Batch 작업 : 
   [Reader 최적화와 파티셔닝 도입](https://ranny-devlog.tistory.com/entry/%EC%84%B1%EB%8A%A5-%EC%B5%9C%EC%A0%81%ED%99%94-300%EB%A7%8C-%EA%B1%B4%EC%9D%98-%EB%B0%B0%EC%B9%98-%EC%9E%91%EC%97%85%EC%9D%84-%EC%84%B1%EB%8A%A5-%EA%B0%9C%EC%84%A0%ED%95%B4%EB%B3%B4%EC%9E%90-8235-%EA%B0%9C%EC%84%A0)

| 단계 | 데이터 규모 | 처리시간 | 개선율          |
| --- | --- | --- |--------------|
| 최적화 전 | 300만 건 | 90분 + | -            |
| 1차 최적화 | 300만 건 | 34분 6초 | **↓ 62.22%** |
| 2차 최적화 | 300만 건 | 6분 29초 | **↓ 82.35%** |

- 1차 최적화 : 데이터베이스 인덱싱, 쿼리 최적화, Reader 리팩토링 (API 페이징 적용, 특정 Reader JDBC 직접 사용)
- 2차 최적화 : Spring Batch 파티셔닝 도입, Writer saveAll로 저장

<br>

2. 통계 조회 API : 다중 컬럼 인덱싱을 활용
    -  **약 300만 건 -  쿼리 응답 시간 7798 ms -> 1.474 ms 으로 개선**

[Before]

- created_at 필드로 필터링 후, daily_views 기준으로 정렬하여 상위 5개 데이터를 추출하는 과정에서 성능 저하 발생<br>
  -> 정렬 단계에서 300만 행을 처리하여 쿼리 응답 시간이 7798 ms 소요

[After]

- `created_at` 와 `daily_views` 필드를 다중 컬럼 인덱스 설정
   - created_at 필드 : 필터링 조건으로 사용되며, 조건 기반 필터링 최적화
   - daily_views 필드 : 정렬 기준으로 사용되며, 인덱스 설계 시 포함하여 정렬 과정 제거
   - 인덱스 적용 후 EXPLAIN ANALYZE 결과에서 정렬 단계 제거 확인

부하 테스트 결과

| 단계      | 데이터 규모  | TPS            | 응답 시간        |
|---------|---------|----------------|--------------|
| 최적화 전   | 50만 건   | 0.77 /sec      | 12,827 ms    | 
| 최적화 후   | 50만 건   | 48.4 /sec      | 15 ms        | 
| **개선율** | -       | **↑ 6185.71%** | **↓ 99.88%** | 


<br>

3. 정산 조회 API : Redis 캐싱 활용
   - **조회 API 응답 속도 1371ms -> 392ms**

| 단계      | 데이터 규모  | TPS            | 응답 시간        |
|---------|---------|----------------|--------------|
| 최적화 전   | 50만 건   | 2.3 /sec      | 27,813 ms    | 
| 최적화 후   | 50만 건   | 15.1 /sec      | 2,688 ms        | 
| **개선율** | -       | **↑ 556.52%** | **↓ 90.34%** | 

- Read-Aside 캐싱 전략을 적용
- Redis에 캐싱된 데이터가 있으면 DB 조회를 생략하고, 데이터를 가져올 수 있도록 최적화

## 💭 기술적 의사결정 및 트러블 슈팅

### 기술적 의사결정

- 레이어드 아키텍처 -> MSA(MicroService Architecture) 전환
  
(링크 추가 예정)

### 트러블 슈팅 경험
- [Redis에서 List\<Dto\> 역직렬화 문제 해결](https://ranny-devlog.tistory.com/entry/%ED%8A%B8%EB%9F%AC%EB%B8%94-%EC%8A%88%ED%8C%85-Redis%EC%97%90%EC%84%9C-ListDto-%EC%97%AD%EC%A7%81%EB%A0%AC%ED%99%94-%EB%AC%B8%EC%A0%9C-%ED%95%B4%EA%B2%B0-%EA%B3%BC%EC%A0%95)



